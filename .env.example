# =============================================================================
# PUDA Workflow Engine — Environment Variables
# Copy to .env and fill in values for your environment.
# In Cloud Run, set these via the console or gcloud CLI.
# =============================================================================

# --- Server ---
# Cloud Run provides PORT automatically; for local dev:
API_PORT=3001
API_HOST=0.0.0.0

# --- Database ---
# REQUIRED in non-test runtime.
# Local docker-compose maps host port 5433 -> container 5432.
DATABASE_URL=postgres://puda:puda@localhost:5433/puda
# Optional test-specific override used by Vitest setup. If omitted, tests fall back to DATABASE_URL.
DATABASE_URL_TEST=postgres://puda:puda@localhost:5433/puda
#
# Cloud SQL (production via Unix socket — set by Secret Manager in Cloud Run):
# DATABASE_URL=postgresql://puda:PASSWORD@/puda?host=/cloudsql/PROJECT:REGION:INSTANCE
# Example:
# DATABASE_URL=postgresql://puda:s3cret@/puda?host=/cloudsql/wealth-report:europe-west1:free-trial-first-project
#
# Cloud SQL via Auth Proxy on localhost (for local dev against Cloud SQL):
# DATABASE_URL=postgres://puda:PASSWORD@localhost:5432/puda
# Run: cloud-sql-proxy wealth-report:europe-west1:free-trial-first-project --port 5432
#
# Set to "false" only in local development.
# In production, DATABASE_SSL must not be false (auto-skipped for Unix socket connections).
DATABASE_SSL=false
# Production TLS verification (provide one — not needed for Unix socket / Cloud SQL connector):
# DATABASE_SSL_CA=-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----
# DATABASE_SSL_CA_BASE64=<base64-encoded-ca-pem>
# DATABASE_SSL_CA_PATH=/path/to/ca.pem

# --- Authentication ---
# REQUIRED in non-test runtime. Generate with: openssl rand -base64 32
JWT_SECRET=puda-dev-secret-DO-NOT-USE-IN-PRODUCTION
# Enforce jti claim on JWTs in non-test runtime.
JWT_ENFORCE_JTI=true
# Officer decision actions (APPROVE/REJECT) require MFA challenge+code when enabled.
OFFICER_MFA_REQUIRED_ON_DECISION=false
# MFA challenge settings
OFFICER_MFA_CODE_TTL_MINUTES=10
OFFICER_MFA_MAX_ATTEMPTS=5
OFFICER_MFA_DELIVERY_CHANNELS=sms,email
# Return OTP in API response (dev/test only).
MFA_DEBUG_RETURN_CODE=false
# TEST ONLY: set to "true" to bypass OTP check in verify endpoint.
# API startup fails if enabled outside test runtime.
AADHAR_OTP_DEV_BYPASS=false
# OTP lockout controls
OTP_MAX_ATTEMPTS=5
OTP_LOCK_MINUTES=15

# --- CORS ---
# REQUIRED in non-test runtime. Comma-separated list of allowed origins.
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:5174

# --- Storage ---
# Directory for uploaded documents. Defaults to ./uploads.
# In Cloud Run, use a mounted volume or switch to GCS.
STORAGE_BASE_DIR=./uploads
# Maximum upload size enforced at storage layer (bytes). Default 25 MB.
STORAGE_MAX_FILE_BYTES=26214400

# --- Email (Nodemailer) ---
# Adapter selection: "stub" (default, no external calls) or "smtp".
EMAIL_PROVIDER=stub
# Production guard: set true only if you intentionally allow stub in production.
ALLOW_STUB_EMAIL_PROVIDER_IN_PRODUCTION=false
# Set EMAIL_ENABLED=true to send real emails; otherwise logs to console.
EMAIL_ENABLED=false
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=
SMTP_PASS=
SMTP_FROM=PUDA <noreply@puda.gov.in>

# --- SLA Checker ---
# Interval in ms for SLA breach detection (default: 30 minutes)
SLA_CHECK_INTERVAL_MS=1800000
# Initial delay in ms before first SLA scan after startup (default: 30 seconds)
SLA_CHECK_INITIAL_DELAY_MS=30000

# --- Payment callback verification ---
# Adapter selection: "stub" (default, no external API dependency).
PAYMENT_GATEWAY_PROVIDER=stub
# Production guard: set true only if you intentionally allow stub in production.
ALLOW_STUB_PAYMENT_PROVIDER_IN_PRODUCTION=false
# REQUIRED in production for gateway callback signature validation.
PAYMENT_GATEWAY_WEBHOOK_SECRET=
# Set to "true" to enforce signatures in non-production too.
PAYMENT_SIGNATURE_REQUIRED=false

# --- SMS ---
# Adapter selection: "stub" (default, no external calls).
SMS_PROVIDER=stub
# Production guard: set true only if you intentionally allow stub in production.
ALLOW_STUB_SMS_PROVIDER_IN_PRODUCTION=false
# Set SMS_ENABLED=true once a real SMS adapter is wired in.
SMS_ENABLED=false

# --- Logging ---
# Set to "true" to log all SQL queries (not recommended in production)
LOG_QUERIES=false
# Maximum DB pool connections per API instance.
DB_POOL_MAX=8
# Warn when a DB query exceeds this duration (milliseconds).
DB_SLOW_QUERY_MS=500

# --- Observability / Tracing ---
# Set OTEL_ENABLED=false to disable tracing.
OTEL_ENABLED=true
OTEL_SERVICE_NAME=puda-api
# Optional OTLP trace export endpoint (if unset, spans are generated but not exported).
# Example: http://otel-collector:4318/v1/traces
OTEL_EXPORTER_OTLP_ENDPOINT=
# Optional OpenTelemetry diagnostics level: ALL|VERBOSE|DEBUG|INFO|WARN|ERROR|NONE
OTEL_DIAG_LOG_LEVEL=INFO

# --- Workflow backlog metrics ---
# Publish open/overdue task gauges for queue/backlog visibility.
ENABLE_WORKFLOW_BACKLOG_METRICS=true
WORKFLOW_BACKLOG_METRICS_INTERVAL_MS=30000
# Cleanup interval for expired JWT denylist entries.
JWT_DENYLIST_CLEANUP_INTERVAL_MS=3600000
# Cleanup interval for expired/unused MFA challenges.
MFA_CHALLENGE_CLEANUP_INTERVAL_MS=900000
# Optional runtime verifier for tamper-evident audit hash chain.
ENABLE_AUDIT_CHAIN_VERIFICATION_JOB=false
AUDIT_CHAIN_VERIFY_INTERVAL_MS=21600000
# Feature-flag cache TTL in ms (admin updates invalidate cache immediately).
FEATURE_FLAG_CACHE_TTL_MS=15000

# --- API Docs ---
# Enable Swagger UI + OpenAPI JSON endpoint in production.
# Non-production defaults to enabled.
ENABLE_API_DOCS=false

# --- Frontend (build-time) ---
# Set when building citizen/officer Docker images:
# VITE_API_BASE_URL=https://api.puda.gov.in
